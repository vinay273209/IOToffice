<!DOCTYPE html>
<html>
<head>
  <title>Smart Home Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: #0f2027;
      background: linear-gradient(to right, #2c5364, #203a43, #0f2027);
      color: white;
      text-align: center;
    }

    .login-box {
      margin-top: 120px;
    }

    input {
      padding: 10px;
      margin: 10px;
      border-radius: 6px;
      border: none;
    }

    button {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .container {
      display: none;
      padding: 20px;
    }

    .card {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      margin: 15px;
      border-radius: 15px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input { display:none; }

    .slider {
      position: absolute;
      cursor: pointer;
      background-color: #ccc;
      border-radius: 34px;
      top: 0; left: 0; right: 0; bottom: 0;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #4CAF50;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .status-dot {
      height: 12px;
      width: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-left: 10px;
    }

    .online { background: lime; }
    .offline { background: red; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-box" id="loginBox">
  <h2>Login</h2>
  <input type="password" id="pass" placeholder="Enter Password">
  <br>
  <button onclick="login()">Enter</button>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboard">

  <h1>ğŸ  Smart Home Pro</h1>
  Device Status: <span id="deviceStatus" class="status-dot offline"></span>

  <div class="card">
    <h2>ğŸ’¡ Light</h2>
    <label class="switch">
      <input type="checkbox" id="lightToggle" onchange="toggleLight()">
      <span class="slider"></span>
    </label>
  </div>

  <div class="card">
    <h2>ğŸŒ€ Fan</h2>
    <label class="switch">
      <input type="checkbox" id="fanToggle" onchange="toggleFan()">
      <span class="slider"></span>
    </label>
  </div>

  <div class="card">
    <h2>ğŸŒ¡ Temperature</h2>
    <canvas id="tempChart"></canvas>
  </div>

  <div class="card">
    <h2>ğŸ’§ Humidity</h2>
    <canvas id="humChart"></canvas>
  </div>

</div>

<script>

// ===== LOGIN =====
function login() {
  if (document.getElementById("pass").value === "1234") {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
  } else {
    alert("Wrong Password");
  }
}

// ===== MQTT =====
const client = mqtt.connect(
  "wss://z9262f1f.ala.eu-central-1.emqxsl.com:8084/mqtt",
  {
    username: "NIET_273209",
    password: "Yaniv@273209",
    clientId: "dashboard_" + Math.random().toString(16).substr(2,8),
    reconnectPeriod: 3000
  }
);

let lastMessageTime = Date.now();

client.on("connect", function () {
  client.subscribe("home/#");
});

client.on("message", function (topic, message) {
  const msg = message.toString();
  lastMessageTime = Date.now();

  if(topic === "home/temperature") addData(tempChart, msg);
  if(topic === "home/humidity") addData(humChart, msg);
});

// ===== ONLINE/OFFLINE DETECTION =====
setInterval(() => {
  if(Date.now() - lastMessageTime < 10000) {
    document.getElementById("deviceStatus").className = "status-dot online";
  } else {
    document.getElementById("deviceStatus").className = "status-dot offline";
  }
}, 2000);

// ===== TOGGLES =====
function toggleLight() {
  const state = document.getElementById("lightToggle").checked ? "ON" : "OFF";
  client.publish("home/light/set", state);
}

function toggleFan() {
  const state = document.getElementById("fanToggle").checked ? "ON" : "OFF";
  client.publish("home/fan/set", state);
}

// ===== CHARTS =====
const tempChart = new Chart(document.getElementById("tempChart"), {
  type: "line",
  data: { labels: [], datasets: [{ label: "Temperature Â°C", data: [], borderColor: "orange" }] }
});

const humChart = new Chart(document.getElementById("humChart"), {
  type: "line",
  data: { labels: [], datasets: [{ label: "Humidity %", data: [], borderColor: "cyan" }] }
});

function addData(chart, value) {
  const time = new Date().toLocaleTimeString();
  chart.data.labels.push(time);
  chart.data.datasets[0].data.push(value);

  if(chart.data.labels.length > 20) {
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }

  chart.update();
}

</script>

</body>
</html>